# === √âtape 1 : Builder ===
FROM node:22-alpine AS builder

# Installer les d√©pendances syst√®me n√©cessaires pour Prisma/OpenSSL
RUN apk add --no-cache libc6-compat openssl bash curl

# Cr√©e le r√©pertoire de l'application
WORKDIR /usr/src/app

# Copie package.json et package-lock.json
COPY package*.json ./

# Installe les d√©pendances
RUN npm ci

# Copie tout le code source
COPY . .

# G√©n√®re Prisma Client
RUN npx prisma generate

# Build NestJS
RUN npm run build


# === √âtape 2 : Image finale ===
FROM node:22-alpine

# Installer OpenSSL pour Prisma
RUN apk add --no-cache libc6-compat openssl bash curl

# Cr√©e le r√©pertoire de l'application
WORKDIR /usr/src/app

# Copie les fichiers essentiels depuis le builder
COPY --from=builder /usr/src/app/package*.json ./
COPY --from=builder /usr/src/app/node_modules ./node_modules
COPY --from=builder /usr/src/app/dist ./dist
COPY --from=builder /usr/src/app/prisma ./prisma

# Expose le port
EXPOSE 3000

# Commande de d√©marrage : build + seed + start
CMD ["sh", "-c", "\
  echo 'üå± Running Prisma generate...' && npx prisma generate && \
  echo 'üå± Seeding database...' && node prisma/seed.ts && \
  echo 'üöÄ Starting app...' && node dist/src/main.js \
"]
